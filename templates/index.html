{% extends "base.html" %}
{% block title %}Dashboard - Smart Home{% endblock %}
{% block content %}
<header class="header">
    <h1>Smart Home System</h1>
    <p class="subtitle">Monitor and control your environment. Welcome, {{ session.username }}! (<a href="/logout">Logout</a>)</p>
    {% if role == 'admin' %}
    <form class="admin-email-form" method="POST" action="{{ url_for('update_admin_email') }}">
        <label for="admin_email">Admin Email:</label>
        <input type="email" id="admin_email" name="admin_email" value="{{ admin_email }}" required>
        <button type="submit">Update</button>
    </form>
    {% endif %}
</header>

<nav>
    <ul class="nav-tabs">
        <li><a href="{{ url_for('dashboard') }}" class="active">Dashboard</a></li>
        <li><a href="{{ url_for('light_control') }}">Light Control</a></li>
        <li><a href="{{ url_for('water_flow') }}">Water Flow</a></li>
        <li><a href="{{ url_for('video_feed') }}">Video Feed</a></li>
        <li><a href="{{ url_for('ventilation') }}">Ventilation</a></li>
        <li><a href="{{ url_for('access_areas') }}">Access Areas</a></li>
        <li><a href="{{ url_for('report') }}">Report</a></li>
    </ul>
</nav>

<div class="dashboard-flex">
  <!-- Live Feed Left -->
  <div class="live-feed-section">
    <h2>ğŸ“· Live Feed</h2>
    <div class="camera-box">
      <img src="{{ url_for('camera_feed') }}" alt="Live Feed" style="width: 320px; height: 240px; object-fit: cover;">
    </div>
  </div>
  
  <!-- Recent Intrusions Right -->
  <div class="intrusions-section">
    <h2>ğŸ“¸ Recent Intrusions</h2>
    {% if snapshots %}
      <div class="snapshots-container">
        {% for img in snapshots %}
          <div class="snapshot-box">
            <img src="{{ url_for('snapshot', filename=img) }}" class="snapshot-image" alt="Intrusion">
            <div class="snapshot-timestamp">{{ img.split('_')[1].replace('-', ':') }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>No intrusions recorded yet.</p>
    {% endif %}
  </div>
</div>

<!-- Controllers Row -->
<div class="controllers-row">
  <div class="control-card">
    <h3>ğŸ’¡ Light</h3>
    <button id="light-toggle" class="toggle-button{% if status.light == 'ON' %} active{% endif %}" onclick="lightToggle()">Toggle</button>
  </div>
  <div class="control-card">
    <h3>ğŸŒ¬ï¸ Fan</h3>
    <button id="fan-toggle" class="toggle-button{% if status.fan == 'ON' %} active{% endif %}" onclick="fanToggle()">Toggle</button>
  </div>
  <div class="control-card">
    <h3>ğŸ’§ Water</h3>
    <div>
      <span>Valve: <span id="valve-status">{{ status.valve }}</span></span>
      <button id="valve-toggle" class="toggle-button{% if status.valve == 'OPEN' %} active{% endif %}" onclick="valveToggle()">Toggle</button>
    </div>
    <div>
      <span>Flow Rate: <span id="flow-rate">{{ water_flow.flow_rate }}</span> L/min</span>
    </div>
  </div>
</div>
{% endblock %}
